#!/bin/bash

# Copyright (c) 2015-2016 Keefer Rourke <keefer.rourke@gmail.com>

# Permission is hereby granted, free of charge, to any person obtaining
# a copy of this software and associated documentation files (the "Software"),
# to deal in the Software without restriction, including without limitation the
# rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
# sell copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:

# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.

# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.


# this script will update various icon symlinks based on your machine's
# reported distribution and desktop environment

# define global variables


lsb_format() {
  sed 's/\s+//g;s/[^a-z]//g'<<<${1,,}
}

DISTRO=$(lsb_format "$(lsb_release -si 2>/dev/null)")
DE=$(lsb_format "$XDG_CURRENT_DESKTOP")

distro_error=0
de_error=0

wd=$PWD


# set distributor logo based on distro or de
cd "$wd/places/scalable"

distmatch() {
 case $DISTRO in
    arch) ln -sf distributor-logo-archlinux.svg distributor-logo.svg ;;
    debian|raspbian) ln -sf distributor-logo-debian.svg distributor-logo.svg ;;
    elementaryos) ln -sf distributor-logo-elementaryos.svg distributor-logo.svg ;;
    fedora) ln -sf distributor-logo-fedora.svg distributor-logo.svg ;;
    gentoo) ln -sf distributor-logo-gentoo.svg distributor-logo.svg ;;
    korora) ln -sf distributor-logo-korora.svg distributor-logo.svg ;;
    linuxmint) ln -sf distributor-logo-linuxmint.svg distributor-logo.svg ;;
    mageia) ln -sf distributor-logo-mageia.svg distributor-logo.svg ;;
    manjaro) ln -sf distributor-logo-manjaro.svg distributor-logo.svg ;;
    opensuse) ln -sf distributor-logo-opensuse.svg distributor-logo.svg ;;
    ubuntu) ln -sf distributor-logo-ubuntu.svg distributor-logo.svg ;;
    *) return 1 ;;
 esac
}


alternative_match() {
local pattern="ID=arch:ID=raspbian"
local IFS=:
for i in $pattern; do
if $(grep -wsq "$i" /etc/os-release); then
	DISTRO=${i##*=}
	distmatch
else
	echo "Could not determine distribution logo."
	distro_error=1
	ln -sf distributor-logo-gnome.svg distributor-logo.svg
fi
done
}


#distdetencion
! distmatch && alternative_match

read -p "Use distributor logo from desktop environment? [y/N] " yn
case $yn in
    [Yy]* )
        case $DE in
            gnome) ln -sf distributor-logo-gnome.svg distributor-logo.svg ;;
            unity)  ln -sf distributor-logo-unity.svg distributor-logo.svg ;;
            xfce) ln -sf distributor-logo-xfce.svg distributor-logo.svg ;;
            lxde) ln -sf distributor-logo-lxde.svg distributor-logo.svg ;;
            kde) ln -sf distributor-logo-kde.svg distributor-logo.svg ;;
            *) echo "Could not determine desktop environment... Using distribution logo."
               de_error=1 ;;
         esac
        ;;

    * ) if [ $distro_error -eq 0 ]; then
            echo "Using distribution logo."
        elif [ $distro_error -eq 1 ] || [ $de_error -eq 1 ]; then
            echo "Could not determine distributor logo, you may need to set this manually in places/scalable/"
        fi
        ;;
esac



ln -sf distributor-logo.svg start-here.svg # fixes potentially broken link

cd "$wd"

ln -sfr "$wd"/places/scalable/distributor-logo.svg "$wd"/apps/scalable/cs-desktop.svg
ln -sfr "$wd"/places/scalable/distributor-logo.svg "$wd"/apps/scalable/applications-system.svg

echo "Updated distributor logo."

# update mimetypes based on distro and de
cd "$wd"/mimetypes/scalable

if [ "$DISTRO" == "opensuse" ]; then
	ln -sf application-x-rpm-opensuse.svg application-x-rpm.svg
elif [ "$DISTRO" == "fedora" ]; then
	ln -sf application-x-rpm-fedora.svg application-x-rpm.svg
elif [ "$DISTRO" == "debian" ]; then
	ln -sf application-x-deb-debian.svg application-x-deb.svg
elif [ "$DISTRO" == "ubuntu" ]; then
	ln -sf application-x-deb-ubuntu.svg application-x-deb.svg
elif [ "$DISTRO" == "linuxmint" ]; then
	ln -sf application-x-deb-linuxmint.svg application-x-deb.svg
	ln -sf application-x-desktop-linuxmint.svg application-x-desktop.svg
else
	ln -sf application-x-deb-debian.svg application-x-deb.svg
	ln -sf application-x-rpm-redhat.svg application-x-rpm.svg
fi

echo "Updated package archive icons."

if [ "$DE" == "gnome" ]; then
	ln -sf application-x-desktop-gnome.svg application-x-desktop.svg
elif [ "$DE" == "unity" ]; then
	ln -sf application-x-desktop-unity.svg application-x-desktop.svg
elif [ "$DE" == "lxde" ]; then
	ln -sf application-x-desktop-lxde.svg application-x-desktop.svg
elif [ "$DE" == "xfce" ]; then
	ln -sf application-x-desktop-xfce.svg application-x-desktop.svg
elif [ "$DE" == "kde" ]; then
	ln -sf application-x-desktop-kde.svg application-x-desktop.svg
fi

echo "Updated mimetype icons."

cd "$wd"
